<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema de Treinos - Recuperação & Performance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; transition: all 0.3s ease; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; }
        .notes-area { white-space: pre-wrap; word-wrap: break-word; }
        .card-enter { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- TELA DE LOGIN -->
    <div id="auth-screen" class="hidden fixed inset-0 bg-slate-50 flex items-center justify-center p-4 z-[100]">
        <div class="bg-white w-full max-w-sm p-8 rounded-2xl shadow-xl border border-slate-200">
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Acesso Profissional</h2>
            <p class="text-slate-500 text-sm mb-6">Entre para gerenciar seus protocolos de recuperação e hipertrofia.</p>
            <div class="space-y-4">
                <input type="email" id="login-email" placeholder="Seu e-mail" class="w-full border p-3 rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="login-pass" placeholder="Sua senha" class="w-full border p-3 rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="handleLogin()" id="btn-login" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-all">Entrar</button>
            </div>
            <div id="login-error" class="mt-4 text-red-500 text-xs text-center hidden"></div>
        </div>
    </div>

    <!-- TELA DE CARREGAMENTO -->
    <div id="loading-screen" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-[200]">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
        <p class="text-slate-500 font-medium">Sincronizando dados...</p>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app" class="max-w-4xl mx-auto hidden">
        <header class="mb-8 border-b border-slate-200">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">Recuperação & Treino</h1>
                    <div id="user-display" class="text-[10px] text-slate-400 mt-1 uppercase font-bold tracking-widest"></div>
                </div>
                <button onclick="handleLogout()" class="text-slate-400 hover:text-red-500 text-sm font-semibold transition-colors">Sair</button>
            </div>
            <nav class="flex gap-8">
                <button onclick="switchTab('montar')" id="tab-montar" class="pb-3 font-semibold text-slate-500 tab-active transition-all">Fila de Montagem</button>
                <button onclick="switchTab('dia')" id="tab-dia" class="pb-3 font-semibold text-slate-500 transition-all">Prescrição do Dia</button>
            </nav>
        </header>

        <!-- ABA: FILA DE MONTAGEM -->
        <main id="content-montar">
            <div class="flex justify-between items-center mb-6">
                <div class="bg-white p-3 rounded-lg border border-slate-200 shadow-sm flex items-center gap-2">
                    <span class="text-slate-500 text-xs uppercase font-bold">Pendentes:</span>
                    <span id="countPending" class="text-xl font-bold text-blue-600">0</span>
                </div>
                <button onclick="openModal('montar')" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold shadow hover:bg-blue-700 transition-all">+ Novo Aluno</button>
            </div>
            <div id="studentList" class="grid gap-4"></div>
        </main>

        <!-- ABA: PRESCRIÇÃO DO DIA -->
        <main id="content-dia" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-slate-700">Prescrições Ativas</h2>
                <button onclick="openModal('dia')" class="bg-emerald-600 text-white px-5 py-2 rounded-lg font-semibold shadow hover:bg-emerald-700 transition-all">+ Novo Treino</button>
            </div>
            <div id="dailyList" class="grid gap-4"></div>
        </main>
    </div>

    <!-- MODAIS (Unificados no mesmo arquivo) -->
    <div id="modal-montar" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-[300]">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 card-enter">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Novo Aluno na Fila</h2>
            <form id="form-montar" class="space-y-4">
                <input type="text" id="name-montar" required placeholder="Nome do Aluno" class="w-full border p-3 rounded-lg">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="gym-montar" required placeholder="Academia" class="w-full border p-3 rounded-lg">
                    <input type="text" id="enrollment-montar" placeholder="Matrícula" class="w-full border p-3 rounded-lg">
                </div>
                <textarea id="obs-montar" rows="3" placeholder="Notas de Lesão / Objetivo" class="w-full border p-3 rounded-lg"></textarea>
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeModal('montar')" class="flex-1 py-3 text-slate-500 font-bold">Cancelar</button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg">Adicionar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-dia" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-[300]">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 card-enter">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Prescrever Sessão</h2>
            <form id="form-dia" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="name-dia" required placeholder="Nome do Aluno" class="w-full border p-3 rounded-lg">
                    <input type="text" id="muscle-dia" required placeholder="Foco / Grupamento" class="w-full border p-3 rounded-lg">
                </div>
                <textarea id="notes-dia" rows="8" required placeholder="Exercícios, séries e repetições..." class="w-full border p-3 rounded-lg"></textarea>
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeModal('dia')" class="flex-1 py-3 text-slate-500 font-bold">Cancelar</button>
                    <button type="submit" class="flex-1 bg-emerald-600 text-white font-bold py-3 rounded-lg">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDa-kFAP_jyErQVBeouZXppWEBVlE6SluI",
            authDomain: "montadordetreinos.firebaseapp.com",
            projectId: "montadordetreinos",
            storageBucket: "montadordetreinos.firebasestorage.app",
            messagingSenderId: "282706566428",
            appId: "1:282706566428:web:0a0468db3b4d38b44ceed9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_COLLECTION = "gerenciador-v4-unificado";

        let currentUserId = null;

        // AUTH LISTENER
        onAuthStateChanged(auth, (user) => {
            document.getElementById('loading-screen').classList.add('hidden');
            if (user) {
                currentUserId = user.uid;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('user-display').innerText = `Profissional: ${user.email.split('@')[0]}`;
                setupRealtimeListeners(user.uid);
            } else {
                document.getElementById('app').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });

        // LOGIN / LOGOUT
        window.handleLogin = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const btn = document.getElementById('btn-login');
            const err = document.getElementById('login-error');
            
            if(!email || !pass) return;
            
            btn.innerText = "Entrando...";
            btn.disabled = true;
            err.classList.add('hidden');

            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                err.innerText = "Erro: E-mail ou senha inválidos.";
                err.classList.remove('hidden');
                btn.innerText = "Entrar";
                btn.disabled = false;
            }
        };

        window.handleLogout = () => signOut(auth);

        // REALTIME DATA
        function setupRealtimeListeners(uid) {
            // Fila de Montagem
            onSnapshot(collection(db, 'artifacts', APP_COLLECTION, 'users', uid, 'students'), (snap) => {
                const list = document.getElementById('studentList');
                const students = snap.docs.map(d => ({id: d.id, ...d.data()}));
                document.getElementById('countPending').innerText = students.length;
                list.innerHTML = students.length ? '' : '<p class="text-center py-10 text-slate-400">Fila vazia.</p>';
                students.forEach(s => {
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center card-enter";
                    el.innerHTML = `<div><div class="flex items-center gap-2 font-bold">${s.name} <span class="text-[9px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded uppercase">${s.gym}</span></div><p class="text-xs text-slate-500">${s.obs || ''}</p></div><button onclick="deleteItem('students', '${s.id}')" class="text-slate-300 hover:text-green-500 transition-colors p-2"><svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"></path></svg></button>`;
                    list.appendChild(el);
                });
            });

            // Prescrições do Dia
            onSnapshot(collection(db, 'artifacts', APP_COLLECTION, 'users', uid, 'daily_workouts'), (snap) => {
                const list = document.getElementById('dailyList');
                const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                list.innerHTML = data.length ? '' : '<p class="text-center py-10 text-slate-400">Nenhum treino prescrito hoje.</p>';
                data.forEach(w => {
                    const el = document.createElement('div');
                    el.className = "bg-white p-5 rounded-2xl border border-slate-200 shadow-sm card-enter";
                    el.innerHTML = `<div class="flex justify-between items-start mb-2"><div><h3 class="font-bold text-lg">${w.name}</h3><span class="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded font-bold uppercase">${w.muscle}</span></div><button onclick="deleteItem('daily_workouts', '${w.id}')" class="text-slate-200 hover:text-red-500 p-1 transition-colors"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"></path></svg></button></div><div class="notes-area text-sm text-slate-600 bg-slate-50 p-3 rounded-lg border border-slate-100">${w.notes}</div>`;
                    list.appendChild(el);
                });
            });
        }

        // CRUD
        window.deleteItem = async (col, id) => {
            if(confirm("Deseja concluir/excluir este item?")) {
                await deleteDoc(doc(db, 'artifacts', APP_COLLECTION, 'users', currentUserId, col, id));
            }
        };

        document.getElementById('form-montar').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('name-montar').value,
                gym: document.getElementById('gym-montar').value,
                enrollment: document.getElementById('enrollment-montar').value,
                obs: document.getElementById('obs-montar').value,
                createdAt: new Date().toISOString()
            };
            await addDoc(collection(db, 'artifacts', APP_COLLECTION, 'users', currentUserId, 'students'), data);
            e.target.reset(); closeModal('montar');
        };

        document.getElementById('form-dia').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('name-dia').value,
                muscle: document.getElementById('muscle-dia').value,
                notes: document.getElementById('notes-dia').value,
                createdAt: new Date().toISOString()
            };
            await addDoc(collection(db, 'artifacts', APP_COLLECTION, 'users', currentUserId, 'daily_workouts'), data);
            e.target.reset(); closeModal('dia');
        };

        // UI HELPERS
        window.switchTab = (tab) => {
            document.getElementById('content-montar').classList.toggle('hidden', tab !== 'montar');
            document.getElementById('content-dia').classList.toggle('hidden', tab !== 'dia');
            document.getElementById('tab-montar').classList.toggle('tab-active', tab === 'montar');
            document.getElementById('tab-dia').classList.toggle('tab-active', tab === 'dia');
        };
        window.openModal = (id) => document.getElementById(`modal-${id}`).classList.replace('hidden', 'flex');
        window.closeModal = (id) => document.getElementById(`modal-${id}`).classList.replace('flex', 'hidden');

    </script>
</body>
</html>
